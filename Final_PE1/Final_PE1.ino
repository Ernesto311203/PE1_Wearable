#include <BLEDevice.h>
#include <BLEServer.h>
#include <BLEUtils.h>
#include <BLE2902.h>
#include <BLEAdvertising.h>

// Partes del sensor de temperatura
#include <Wire.h>
#include <Adafruit_Sensor.h>
#include <Adafruit_BMP280.h>
#define I2C_SDA 21
#define I2C_SCL 22

Adafruit_BMP280 bmp; // sensor BMP280 (RECORDAR ESTO ES IMPORTANTE)

#define SERVICE_UUID           "6E400001-B5A3-F393-E0A9-E50E24DCCA9E"
#define CHARACTERISTIC_UUID_RX "6E400002-B5A3-F393-E0A9-E50E24DCCA9E"
#define CHARACTERISTIC_UUID_TX "6E400003-B5A3-F393-E0A9-E50E24DCCA9E"

#define FS 125
#define MIN_PROM 0.6
#define MIN_DIST 50
#define WINDOW 200

BLEServer* pServer = nullptr;
BLECharacteristic* pTxCharacteristic = nullptr;

const int PPG_LEN = 1024;

float detrended[PPG_LEN];
float normalized[PPG_LEN];
float detrended2[PPG_LEN];
float normalized2[PPG_LEN];
int peaks[PPG_LEN];

bool deviceConnected = false;

#include "bpm_estimator.h"

class MyServerCallbacks : public BLEServerCallbacks {
  void onConnect(BLEServer* pServer) override {
    deviceConnected = true;
    Serial.println("Cliente conectado");
  }

  void onDisconnect(BLEServer* pServer) override {
    deviceConnected = false;
    Serial.println("Cliente desconectado");
    pServer->startAdvertising();
    Serial.println("Reiniciando publicidad BLE");
  }
};

float ppg_data[1024] = {
  1826345.0f, 1827211.0f, 1828220.0f, 1829187.0f, 1830152.0f, 1831606.0f, 1832633.0f, 1834255.0f, 
  1835238.0f, 1836877.0f, 1837631.0f, 1838540.0f, 1838784.0f, 1839313.0f, 1839034.0f, 1839164.0f, 
  1839080.0f, 1839371.0f, 1839764.0f, 1839984.0f, 1840712.0f, 1841017.0f, 1841229.0f, 1841491.0f, 
  1841064.0f, 1841032.0f, 1840286.0f, 1840003.0f, 1839810.0f, 1839685.0f, 1839415.0f, 1838862.0f, 
  1838502.0f, 1838526.0f, 1838333.0f, 1838471.0f, 1838307.0f, 1838134.0f, 1837956.0f, 1837712.0f, 
  1837587.0f, 1837202.0f, 1837207.0f, 1837122.0f, 1837439.0f, 1837101.0f, 1837439.0f, 1836946.0f, 
  1837011.0f, 1837006.0f, 1836565.0f, 1836266.0f, 1835819.0f, 1835281.0f, 1835071.0f, 1834712.0f, 
  1834813.0f, 1834441.0f, 1834334.0f, 1834264.0f, 1833646.0f, 1833221.0f, 1832324.0f, 1831895.0f, 
  1831210.0f, 1831634.0f, 1832088.0f, 1832732.0f, 1833947.0f, 1835026.0f, 1835823.0f, 1836569.0f, 
  1837704.0f, 1838342.0f, 1839389.0f, 1840421.0f, 1841190.0f, 1842549.0f, 1843302.0f, 1843961.0f, 
  1844119.0f, 1844520.0f, 1844064.0f, 1844368.0f, 1844269.0f, 1844238.0f, 1844756.0f, 1844920.0f, 
  1845380.0f, 1845652.0f, 1845399.0f, 1844869.0f, 1844436.0f, 1844171.0f, 1843689.0f, 1843637.0f, 
  1843402.0f, 1842922.0f, 1843206.0f, 1843262.0f, 1842836.0f, 1842580.0f, 1841999.0f, 1841493.0f, 
  1841129.0f, 1840944.0f, 1840899.0f, 1840998.0f, 1841003.0f, 1841159.0f, 1841074.0f, 1841338.0f, 
  1841347.0f, 1841248.0f, 1840940.0f, 1840770.0f, 1840239.0f, 1840450.0f, 1840062.0f, 1840209.0f, 
  1839874.0f, 1840116.0f, 1840022.0f, 1840102.0f, 1839745.0f, 1839860.0f, 1839419.0f, 1839169.0f, 
  1839298.0f, 1839096.0f, 1838401.0f, 1838200.0f, 1838173.0f, 1838157.0f, 1838250.0f, 1838969.0f, 
  1839647.0f, 1840889.0f, 1841933.0f, 1842800.0f, 1843793.0f, 1844876.0f, 1846172.0f, 1847422.0f, 
  1848538.0f, 1849843.0f, 1850643.0f, 1851784.0f, 1852153.0f, 1852724.0f, 1852593.0f, 1852717.0f, 
  1852364.0f, 1852231.0f, 1852022.0f, 1851596.0f, 1851804.0f, 1851755.0f, 1851627.0f, 1851726.0f, 
  1851667.0f, 1851673.0f, 1851331.0f, 1850814.0f, 1850620.0f, 1850360.0f, 1849898.0f, 1849267.0f, 
  1848569.0f, 1847975.0f, 1847349.0f, 1847149.0f, 1846989.0f, 1846601.0f, 1846947.0f, 1847079.0f, 
  1847353.0f, 1847558.0f, 1847185.0f, 1847129.0f, 1847052.0f, 1846904.0f, 1846514.0f, 1846814.0f, 
  1846800.0f, 1846286.0f, 1846429.0f, 1845793.0f, 1845843.0f, 1845085.0f, 1844808.0f, 1844169.0f, 
  1844317.0f, 1843903.0f, 1844007.0f, 1843911.0f, 1843571.0f, 1843372.0f, 1842737.0f, 1842458.0f, 
  1842178.0f, 1841855.0f, 1841587.0f, 1841161.0f, 1840806.0f, 1840557.0f, 1840212.0f, 1840674.0f, 
  1841148.0f, 1842397.0f, 1843562.0f, 1844719.0f, 1845615.0f, 1847058.0f, 1848528.0f, 1849905.0f, 
  1850835.0f, 1852052.0f, 1852976.0f, 1853851.0f, 1854391.0f, 1854810.0f, 1854904.0f, 1854987.0f, 
  1854879.0f, 1855047.0f, 1854943.0f, 1854771.0f, 1854645.0f, 1854326.0f, 1854056.0f, 1853453.0f, 
  1853134.0f, 1852527.0f, 1851935.0f, 1851324.0f, 1850797.0f, 1850198.0f, 1849853.0f, 1849048.0f, 
  1848480.0f, 1847948.0f, 1847410.0f, 1846817.0f, 1846133.0f, 1845937.0f, 1845164.0f, 1845246.0f, 
  1845138.0f, 1844903.0f, 1845075.0f, 1845095.0f, 1844535.0f, 1844675.0f, 1844343.0f, 1844432.0f, 
  1844021.0f, 1844017.0f, 1844069.0f, 1843792.0f, 1843843.0f, 1843746.0f, 1843562.0f, 1843672.0f, 
  1843220.0f, 1843101.0f, 1842844.0f, 1842333.0f, 1841960.0f, 1841773.0f, 1841414.0f, 1841574.0f, 
  1841264.0f, 1841234.0f, 1841046.0f, 1840424.0f, 1840369.0f, 1839757.0f, 1839372.0f, 1839255.0f, 
  1839477.0f, 1840163.0f, 1840596.0f, 1841510.0f, 1842951.0f, 1844401.0f, 1845938.0f, 1847251.0f, 
  1848264.0f, 1849164.0f, 1849754.0f, 1850494.0f, 1850784.0f, 1850941.0f, 1851187.0f, 1851405.0f, 
  1851361.0f, 1851699.0f, 1851825.0f, 1851494.0f, 1851179.0f, 1850317.0f, 1849195.0f, 1848446.0f, 
  1847532.0f, 1846724.0f, 1846128.0f, 1845669.0f, 1845379.0f, 1844760.0f, 1844642.0f, 1844194.0f, 
  1843713.0f, 1842762.0f, 1842062.0f, 1841199.0f, 1840347.0f, 1840133.0f, 1840194.0f, 1840295.0f, 
  1840537.0f, 1841358.0f, 1841563.0f, 1841750.0f, 1841627.0f, 1841046.0f, 1840890.0f, 1840664.0f, 
  1840281.0f, 1840102.0f, 1840427.0f, 1840281.0f, 1840657.0f, 1840428.0f, 1840352.0f, 1840481.0f, 
  1839693.0f, 1839498.0f, 1838912.0f, 1838486.0f, 1838279.0f, 1837791.0f, 1837999.0f, 1838152.0f, 
  1837977.0f, 1837762.0f, 1837316.0f, 1836758.0f, 1836151.0f, 1835488.0f, 1835270.0f, 1835209.0f, 
  1835755.0f, 1836956.0f, 1838269.0f, 1839396.0f, 1840709.0f, 1841547.0f, 1842738.0f, 1843654.0f, 
  1844379.0f, 1845172.0f, 1846147.0f, 1846681.0f, 1847585.0f, 1848223.0f, 1848439.0f, 1848868.0f, 
  1849124.0f, 1849017.0f, 1849282.0f, 1849225.0f, 1848812.0f, 1848932.0f, 1848713.0f, 1848412.0f, 
  1848291.0f, 1847923.0f, 1847522.0f, 1847192.0f, 1846572.0f, 1846370.0f, 1845870.0f, 1845725.0f, 
  1845218.0f, 1844790.0f, 1844339.0f, 1843993.0f, 1843709.0f, 1843609.0f, 1843368.0f, 1843494.0f, 
  1843233.0f, 1843344.0f, 1842911.0f, 1843131.0f, 1842577.0f, 1842366.0f, 1841920.0f, 1841374.0f, 
  1841165.0f, 1840547.0f, 1839999.0f, 1839456.0f, 1838963.0f, 1838343.0f, 1837940.0f, 1837674.0f, 
  1837531.0f, 1837903.0f, 1838512.0f, 1839093.0f, 1839892.0f, 1840089.0f, 1839908.0f, 1838980.0f, 
  1838516.0f, 1837722.0f, 1837688.0f, 1837760.0f, 1838365.0f, 1839244.0f, 1840496.0f, 1841726.0f, 
  1843277.0f, 1844658.0f, 1845876.0f, 1846775.0f, 1847626.0f, 1848332.0f, 1849573.0f, 1850222.0f, 
  1850934.0f, 1851604.0f, 1852266.0f, 1852663.0f, 1852798.0f, 1852583.0f, 1852136.0f, 1852390.0f, 
  1851666.0f, 1851903.0f, 1851649.0f, 1851843.0f, 1851855.0f, 1852150.0f, 1851638.0f, 1851256.0f, 
  1850667.0f, 1849757.0f, 1849382.0f, 1848864.0f, 1848953.0f, 1848928.0f, 1849606.0f, 1849534.0f, 
  1849709.0f, 1849591.0f, 1849776.0f, 1849617.0f, 1849872.0f, 1849783.0f, 1849694.0f, 1849560.0f, 
  1849464.0f, 1849627.0f, 1849604.0f, 1849670.0f, 1849723.0f, 1849666.0f, 1849630.0f, 1848998.0f, 
  1848679.0f, 1848603.0f, 1848577.0f, 1848693.0f, 1848279.0f, 1847565.0f, 1846858.0f, 1845985.0f, 
  1844792.0f, 1843957.0f, 1842901.0f, 1842235.0f, 1842093.0f, 1841760.0f, 1841557.0f, 1841183.0f, 
  1840554.0f, 1840259.0f, 1840020.0f, 1840324.0f, 1840925.0f, 1841948.0f, 1842643.0f, 1843897.0f, 
  1845459.0f, 1846462.0f, 1848286.0f, 1849503.0f, 1850880.0f, 1852066.0f, 1853168.0f, 1854035.0f, 
  1854508.0f, 1855085.0f, 1855608.0f, 1855985.0f, 1856338.0f, 1856451.0f, 1856780.0f, 1856482.0f, 
  1856712.0f, 1856248.0f, 1855896.0f, 1855167.0f, 1854898.0f, 1854309.0f, 1853796.0f, 1853400.0f, 
  1853087.0f, 1852751.0f, 1852644.0f, 1851946.0f, 1851942.0f, 1851379.0f, 1850637.0f, 1849886.0f, 
  1849213.0f, 1849149.0f, 1848916.0f, 1849232.0f, 1849515.0f, 1849724.0f, 1849821.0f, 1849351.0f, 
  1849193.0f, 1848860.0f, 1848262.0f, 1848400.0f, 1848247.0f, 1848449.0f, 1848915.0f, 1848747.0f, 
  1848549.0f, 1848473.0f, 1848419.0f, 1848110.0f, 1847445.0f, 1847185.0f, 1847014.0f, 1846544.0f, 
  1846535.0f, 1846561.0f, 1845891.0f, 1846133.0f, 1845782.0f, 1845882.0f, 1845577.0f, 1845647.0f, 
  1845438.0f, 1844997.0f, 1844222.0f, 1843725.0f, 1842907.0f, 1842389.0f, 1842472.0f, 1842942.0f, 
  1844210.0f, 1845666.0f, 1847708.0f, 1848793.0f, 1850365.0f, 1851242.0f, 1852169.0f, 1852834.0f, 
  1853430.0f, 1854104.0f, 1854660.0f, 1855234.0f, 1855828.0f, 1856640.0f, 1856605.0f, 1856858.0f, 
  1856370.0f, 1856467.0f, 1855919.0f, 1855538.0f, 1855582.0f, 1855331.0f, 1855287.0f, 1854656.0f, 
  1854359.0f, 1854128.0f, 1853899.0f, 1853453.0f, 1852850.0f, 1852269.0f, 1851918.0f, 1851157.0f, 
  1850554.0f, 1850464.0f, 1850321.0f, 1850341.0f, 1850937.0f, 1851339.0f, 1851189.0f, 1851007.0f, 
  1850837.0f, 1850646.0f, 1850355.0f, 1850115.0f, 1849999.0f, 1850007.0f, 1849876.0f, 1849736.0f, 
  1850180.0f, 1850155.0f, 1850236.0f, 1850074.0f, 1850276.0f, 1849711.0f, 1849410.0f, 1848975.0f, 
  1848733.0f, 1848386.0f, 1848181.0f, 1848582.0f, 1848526.0f, 1848790.0f, 1848767.0f, 1848506.0f, 
  1847812.0f, 1846828.0f, 1846570.0f, 1846181.0f, 1846044.0f, 1845919.0f, 1846132.0f, 1846091.0f, 
  1846308.0f, 1846183.0f, 1846603.0f, 1846673.0f, 1846763.0f, 1847058.0f, 1847671.0f, 1848747.0f, 
  1849573.0f, 1850973.0f, 1852483.0f, 1853640.0f, 1855139.0f, 1856000.0f, 1856705.0f, 1857288.0f, 
  1857645.0f, 1858135.0f, 1858087.0f, 1858326.0f, 1858021.0f, 1857611.0f, 1857554.0f, 1857328.0f, 
  1857654.0f, 1857853.0f, 1858081.0f, 1858107.0f, 1857571.0f, 1856524.0f, 1855129.0f, 1853681.0f, 
  1852823.0f, 1852093.0f, 1851226.0f, 1850822.0f, 1850517.0f, 1849812.0f, 1849321.0f, 1848563.0f, 
  1848384.0f, 1847558.0f, 1847311.0f, 1847091.0f, 1847208.0f, 1847204.0f, 1847521.0f, 1847024.0f, 
  1846831.0f, 1846381.0f, 1846103.0f, 1845827.0f, 1845679.0f, 1845754.0f, 1845628.0f, 1845575.0f, 
  1845413.0f, 1845397.0f, 1845366.0f, 1844773.0f, 1844760.0f, 1844411.0f, 1844262.0f, 1844284.0f, 
  1843937.0f, 1844073.0f, 1844185.0f, 1844440.0f, 1844226.0f, 1844090.0f, 1843058.0f, 1843151.0f, 
  1842668.0f, 1841879.0f, 1841213.0f, 1840055.0f, 1839564.0f, 1839286.0f, 1838898.0f, 1838419.0f, 
  1838286.0f, 1838026.0f, 1838089.0f, 1838469.0f, 1839173.0f, 1839968.0f, 1840835.0f, 1841545.0f, 
  1842547.0f, 1843079.0f, 1843720.0f, 1844413.0f, 1845226.0f, 1845504.0f, 1846105.0f, 1846446.0f, 
  1847102.0f, 1847792.0f, 1848341.0f, 1848855.0f, 1848910.0f, 1849127.0f, 1849635.0f, 1849531.0f, 
  1849606.0f, 1849660.0f, 1849627.0f, 1849189.0f, 1848781.0f, 1848095.0f, 1847089.0f, 1846018.0f, 
  1844190.0f, 1843433.0f, 1842051.0f, 1841554.0f, 1841095.0f, 1841126.0f, 1840941.0f, 1840866.0f, 
  1840211.0f, 1839816.0f, 1839060.0f, 1838721.0f, 1838413.0f, 1838018.0f, 1837986.0f, 1837634.0f, 
  1837588.0f, 1837268.0f, 1836517.0f, 1835455.0f, 1834957.0f, 1834356.0f, 1834042.0f, 1833728.0f, 
  1833113.0f, 1832708.0f, 1832359.0f, 1831903.0f, 1831955.0f, 1831425.0f, 1830845.0f, 1830029.0f, 
  1829651.0f, 1828903.0f, 1828318.0f, 1827911.0f, 1827892.0f, 1827560.0f, 1827925.0f, 1827941.0f, 
  1827540.0f, 1827180.0f, 1827272.0f, 1826957.0f, 1826750.0f, 1826665.0f, 1826841.0f, 1827130.0f, 
  1827953.0f, 1828741.0f, 1829446.0f, 1830514.0f, 1831947.0f, 1833156.0f, 1834255.0f, 1834879.0f, 
  1836013.0f, 1837123.0f, 1837804.0f, 1838168.0f, 1838668.0f, 1838455.0f, 1838688.0f, 1838482.0f, 
  1838288.0f, 1838195.0f, 1837691.0f, 1837934.0f, 1837852.0f, 1837641.0f, 1837394.0f, 1837554.0f, 
  1837516.0f, 1837321.0f, 1837097.0f, 1836709.0f, 1836081.0f, 1835506.0f, 1835046.0f, 1834542.0f, 
  1834860.0f, 1834799.0f, 1834463.0f, 1834285.0f, 1834508.0f, 1833939.0f, 1834299.0f, 1834180.0f, 
  1834060.0f, 1833741.0f, 1833523.0f, 1833386.0f, 1832904.0f, 1832786.0f, 1832993.0f, 1832690.0f, 
  1832073.0f, 1831641.0f, 1830998.0f, 1830422.0f, 1829762.0f, 1829681.0f, 1829370.0f, 1829349.0f, 
  1829399.0f, 1829708.0f, 1829434.0f, 1829049.0f, 1828643.0f, 1828426.0f, 1828163.0f, 1828379.0f, 
  1828302.0f, 1828200.0f, 1828792.0f, 1828865.0f, 1829051.0f, 1828538.0f, 1828324.0f, 1827981.0f, 
  1828685.0f, 1829108.0f, 1830097.0f, 1831452.0f, 1832879.0f, 1834494.0f, 1835860.0f, 1837272.0f, 
  1837897.0f, 1839043.0f, 1839713.0f, 1840565.0f, 1840546.0f, 1840989.0f, 1841162.0f, 1841680.0f, 
  1842218.0f, 1842624.0f, 1842757.0f, 1842878.0f, 1842446.0f, 1842254.0f, 1841871.0f, 1841758.0f, 
  1841874.0f, 1841631.0f, 1841514.0f, 1841180.0f, 1840684.0f, 1839739.0f, 1839060.0f, 1838347.0f, 
  1838199.0f, 1837662.0f, 1837477.0f, 1837369.0f, 1837384.0f, 1837150.0f, 1837442.0f, 1837064.0f, 
  1836722.0f, 1836227.0f, 1835172.0f, 1834547.0f, 1834264.0f, 1833758.0f, 1833798.0f, 1833672.0f, 
  1833941.0f, 1833808.0f, 1833602.0f, 1833392.0f, 1833392.0f, 1833087.0f, 1832579.0f, 1832352.0f, 
  1831455.0f, 1830746.0f, 1829938.0f, 1829214.0f, 1828682.0f, 1828595.0f, 1828714.0f, 1829227.0f, 
  1829239.0f, 1828820.0f, 1828202.0f, 1827491.0f, 1827299.0f, 1826304.0f, 1826266.0f, 1826061.0f, 
  1826390.0f, 1826614.0f, 1826923.0f, 1826756.0f, 1827036.0f, 1827446.0f, 1827899.0f, 1828421.0f, 
  1829447.0f, 1830846.0f, 1832302.0f, 1833631.0f, 1834888.0f, 1835910.0f, 1836814.0f, 1837149.0f, 
  1837443.0f, 1837601.0f, 1837808.0f, 1838158.0f, 1838230.0f, 1839164.0f, 1839225.0f, 1840090.0f, 
  1840238.0f, 1839984.0f, 1839649.0f, 1839835.0f, 1839338.0f, 1839011.0f, 1838808.0f, 1838490.0f, 
  1838207.0f, 1837984.0f, 1837744.0f, 1837429.0f, 1836738.0f, 1836216.0f, 1835698.0f, 1835368.0f, 
  1835378.0f, 1835845.0f, 1835736.0f, 1835678.0f, 1835292.0f, 1835339.0f, 1835708.0f, 1836365.0f, 
  1836572.0f, 1836319.0f, 1836214.0f, 1836034.0f, 1835756.0f, 1835519.0f, 1835076.0f, 1834697.0f, 
  1834146.0f, 1834573.0f, 1834730.0f, 1834930.0f, 1835028.0f, 1834678.0f, 1834797.0f, 1834790.0f, 
  1834471.0f, 1833940.0f, 1833167.0f, 1832478.0f, 1832260.0f, 1832387.0f, 1832642.0f, 1832644.0f, 
  1832475.0f, 1832218.0f, 1831857.0f, 1831944.0f, 1831611.0f, 1831409.0f, 1830748.0f, 1830134.0f
};

float ppg2_data[1024] = {
  4076723.0f, 4076826.0f, 4077808.0f, 4077879.0f, 4077975.0f, 4079093.0f, 4078708.0f, 4079360.0f,
  4080314.0f, 4080637.0f, 4080676.0f, 4081498.0f, 4081331.0f, 4082132.0f, 4082514.0f, 4082653.0f,
  4082520.0f, 4082902.0f, 4083128.0f, 4082955.0f, 4082978.0f, 4083308.0f, 4083225.0f, 4083638.0f,
  4083167.0f, 4083368.0f, 4083346.0f, 4083141.0f, 4083079.0f, 4083364.0f, 4082927.0f, 4082619.0f,
  4082646.0f, 4082655.0f, 4082371.0f, 4082657.0f, 4081942.0f, 4082146.0f, 4081798.0f, 4081790.0f,
  4081622.0f, 4081113.0f, 4081630.0f, 4081366.0f, 4081439.0f, 4081253.0f, 4081418.0f, 4081188.0f,
  4081241.0f, 4080862.0f, 4080775.0f, 4080802.0f, 4080451.0f, 4080367.0f, 4079804.0f, 4080272.0f,
  4080021.0f, 4080025.0f, 4080049.0f, 4079849.0f, 4079636.0f, 4079584.0f, 4079340.0f, 4079304.0f,
  4079208.0f, 4079375.0f, 4079360.0f, 4079588.0f, 4080322.0f, 4080898.0f, 4081205.0f, 4081459.0f,
  4081844.0f, 4082553.0f, 4082840.0f, 4083596.0f, 4083893.0f, 4084161.0f, 4084556.0f, 4085207.0f,
  4085425.0f, 4085707.0f, 4085893.0f, 4085761.0f, 4086570.0f, 4086438.0f, 4086363.0f, 4086598.0f,
  4086412.0f, 4086261.0f, 4086385.0f, 4086516.0f, 4085985.0f, 4085640.0f, 4085671.0f, 4085684.0f,
  4084865.0f, 4085118.0f, 4084987.0f, 4084979.0f, 4085090.0f, 4084799.0f, 4084889.0f, 4084821.0f,
  4084715.0f, 4084521.0f, 4084274.0f, 4084539.0f, 4084039.0f, 4084316.0f, 4084092.0f, 4083865.0f,
  4084346.0f, 4084091.0f, 4083923.0f, 4084268.0f, 4083781.0f, 4084166.0f, 4083776.0f, 4083736.0f,
  4083346.0f, 4083761.0f, 4083910.0f, 4084170.0f, 4083544.0f, 4083798.0f, 4083625.0f, 4083460.0f,
  4083681.0f, 4083560.0f, 4083095.0f, 4083054.0f, 4083063.0f, 4083139.0f, 4082628.0f, 4083213.0f,
  4083864.0f, 4084363.0f, 4085067.0f, 4085735.0f, 4085959.0f, 4086624.0f, 4087011.0f, 4087642.0f,
  4087755.0f, 4087876.0f, 4088230.0f, 4088515.0f, 4088361.0f, 4089564.0f, 4089108.0f, 4089285.0f,
  4089489.0f, 4089273.0f, 4089549.0f, 4089152.0f, 4089708.0f, 4088887.0f, 4088982.0f, 4088859.0f,
  4089013.0f, 4088825.0f, 4088492.0f, 4088273.0f, 4088390.0f, 4088405.0f, 4088044.0f, 4088118.0f,
  4088033.0f, 4088214.0f, 4087596.0f, 4087715.0f, 4087150.0f, 4086952.0f, 4087193.0f, 4087033.0f,
  4086960.0f, 4087117.0f, 4086376.0f, 4087151.0f, 4086575.0f, 4086894.0f, 4087120.0f, 4086422.0f,
  4086509.0f, 4086383.0f, 4085942.0f, 4086088.0f, 4085843.0f, 4086013.0f, 4085435.0f, 4085232.0f,
  4085283.0f, 4084912.0f, 4085097.0f, 4085070.0f, 4084998.0f, 4084958.0f, 4084855.0f, 4084860.0f,
  4085187.0f, 4084835.0f, 4084923.0f, 4084637.0f, 4084758.0f, 4084316.0f, 4084511.0f, 4084682.0f,
  4084945.0f, 4085974.0f, 4086009.0f, 4086811.0f, 4087111.0f, 4087910.0f, 4088625.0f, 4088942.0f,
  4089258.0f, 4089991.0f, 4089793.0f, 4090638.0f, 4090627.0f, 4090688.0f, 4091167.0f, 4091082.0f,
  4090931.0f, 4091276.0f, 4091102.0f, 4090798.0f, 4090604.0f, 4090994.0f, 4090555.0f, 4090400.0f,
  4090274.0f, 4090191.0f, 4090070.0f, 4089518.0f, 4089576.0f, 4089672.0f, 4089035.0f, 4089164.0f,
  4089083.0f, 4088872.0f, 4088514.0f, 4089059.0f, 4088255.0f, 4088227.0f, 4087848.0f, 4087926.0f,
  4087645.0f, 4087501.0f, 4087132.0f, 4087309.0f, 4086974.0f, 4086646.0f, 4086407.0f, 4086412.0f,
  4086500.0f, 4086629.0f, 4086050.0f, 4086703.0f, 4085812.0f, 4086161.0f, 4086107.0f, 4086225.0f,
  4085841.0f, 4086206.0f, 4085459.0f, 4085722.0f, 4085230.0f, 4085421.0f, 4085054.0f, 4084997.0f,
  4085055.0f, 4084749.0f, 4084685.0f, 4084743.0f, 4083946.0f, 4084439.0f, 4083769.0f, 4084263.0f,
  4084283.0f, 4084845.0f, 4084777.0f, 4085354.0f, 4086255.0f, 4086548.0f, 4087259.0f, 4087637.0f,
  4087675.0f, 4088187.0f, 4088352.0f, 4088371.0f, 4088322.0f, 4088578.0f, 4088431.0f, 4088714.0f,
  4088559.0f, 4088635.0f, 4088967.0f, 4088822.0f, 4088369.0f, 4088858.0f, 4087986.0f, 4087870.0f,
  4087401.0f, 4087224.0f, 4086970.0f, 4086396.0f, 4086290.0f, 4086153.0f, 4085310.0f, 4085708.0f,
  4084993.0f, 4084954.0f, 4084767.0f, 4084735.0f, 4084657.0f, 4084325.0f, 4084028.0f, 4084170.0f,
  4083953.0f, 4084122.0f, 4083998.0f, 4084190.0f, 4083932.0f, 4084413.0f, 4084631.0f, 4084156.0f,
  4084256.0f, 4084118.0f, 4083995.0f, 4084218.0f, 4083875.0f, 4084254.0f, 4083698.0f, 4083841.0f,
  4083815.0f, 4083642.0f, 4083710.0f, 4083670.0f, 4083577.0f, 4083134.0f, 4083516.0f, 4083508.0f,
  4083020.0f, 4083188.0f, 4083070.0f, 4083007.0f, 4083048.0f, 4083016.0f, 4082770.0f, 4082788.0f,
  4083154.0f, 4083657.0f, 4083799.0f, 4084421.0f, 4085245.0f, 4085472.0f, 4086057.0f, 4086419.0f,
  4086883.0f, 4087792.0f, 4087973.0f, 4088142.0f, 4088334.0f, 4088629.0f, 4088646.0f, 4089048.0f,
  4089333.0f, 4088898.0f, 4089173.0f, 4089485.0f, 4089226.0f, 4089040.0f, 4089220.0f, 4088677.0f,
  4088865.0f, 4088717.0f, 4088236.0f, 4088519.0f, 4087881.0f, 4087582.0f, 4087488.0f, 4087136.0f,
  4087089.0f, 4087086.0f, 4086580.0f, 4086315.0f, 4086786.0f, 4086257.0f, 4085843.0f, 4086111.0f,
  4085623.0f, 4085823.0f, 4085115.0f, 4085334.0f, 4084921.0f, 4085128.0f, 4085097.0f, 4084899.0f,
  4084709.0f, 4084726.0f, 4084370.0f, 4084170.0f, 4083829.0f, 4083893.0f, 4083114.0f, 4083410.0f,
  4082977.0f, 4082934.0f, 4082664.0f, 4083008.0f, 4083382.0f, 4082714.0f, 4083632.0f, 4083372.0f,
  4083572.0f, 4083510.0f, 4083536.0f, 4083582.0f, 4083463.0f, 4083813.0f, 4083611.0f, 4084644.0f,
  4085152.0f, 4085878.0f, 4086491.0f, 4086850.0f, 4087304.0f, 4087904.0f, 4088323.0f, 4088170.0f,
  4088910.0f, 4088634.0f, 4089085.0f, 4089667.0f, 4089310.0f, 4089717.0f, 4089139.0f, 4089701.0f,
  4089159.0f, 4089271.0f, 4089098.0f, 4088952.0f, 4088801.0f, 4089115.0f, 4088858.0f, 4088838.0f,
  4088658.0f, 4088711.0f, 4088780.0f, 4088272.0f, 4088293.0f, 4088667.0f, 4088375.0f, 4088366.0f,
  4088593.0f, 4088605.0f, 4088495.0f, 4088699.0f, 4088450.0f, 4088483.0f, 4088679.0f, 4088512.0f,
  4088519.0f, 4088157.0f, 4088772.0f, 4088369.0f, 4088382.0f, 4088570.0f, 4088285.0f, 4088517.0f,
  4087806.0f, 4087640.0f, 4088028.0f, 4087700.0f, 4088082.0f, 4087527.0f, 4087655.0f, 4087356.0f,
  4086839.0f, 4086647.0f, 4086264.0f, 4086529.0f, 4085823.0f, 4085851.0f, 4085178.0f, 4085552.0f,
  4084893.0f, 4085141.0f, 4085150.0f, 4085128.0f, 4085807.0f, 4085659.0f, 4086635.0f, 4087418.0f,
  4087791.0f, 4088487.0f, 4088876.0f, 4089614.0f, 4090691.0f, 4090510.0f, 4091692.0f, 4091576.0f,
  4092268.0f, 4092097.0f, 4092842.0f, 4092484.0f, 4092663.0f, 4092675.0f, 4092906.0f, 4092865.0f,
  4093318.0f, 4092427.0f, 4092876.0f, 4092638.0f, 4092684.0f, 4092354.0f, 4092118.0f, 4092266.0f,
  4091884.0f, 4091932.0f, 4091879.0f, 4091442.0f, 4091613.0f, 4091258.0f, 4091567.0f, 4091313.0f,
  4090952.0f, 4090880.0f, 4090655.0f, 4090799.0f, 4090620.0f, 4091013.0f, 4090756.0f, 4090648.0f,
  4090672.0f, 4090472.0f, 4090632.0f, 4090224.0f, 4090186.0f, 4089936.0f, 4090470.0f, 4090227.0f,
  4090099.0f, 4090339.0f, 4090492.0f, 4089891.0f, 4089936.0f, 4089735.0f, 4089602.0f, 4089215.0f,
  4089177.0f, 4089221.0f, 4089412.0f, 4088980.0f, 4089045.0f, 4088916.0f, 4089192.0f, 4088796.0f,
  4089001.0f, 4088873.0f, 4089354.0f, 4088783.0f, 4088986.0f, 4088553.0f, 4088757.0f, 4089019.0f,
  4089535.0f, 4089992.0f, 4090734.0f, 4091227.0f, 4092084.0f, 4092457.0f, 4093025.0f, 4093150.0f,
  4093494.0f, 4093959.0f, 4093682.0f, 4094206.0f, 4094283.0f, 4094701.0f, 4094662.0f, 4094624.0f,
  4094578.0f, 4094614.0f, 4094237.0f, 4094547.0f, 4094390.0f, 4094352.0f, 4094030.0f, 4093999.0f,
  4093885.0f, 4093676.0f, 4093410.0f, 4093259.0f, 4093297.0f, 4093090.0f, 4092714.0f, 4092503.0f,
  4092301.0f, 4092204.0f, 4092247.0f, 4092114.0f, 4092312.0f, 4092205.0f, 4092176.0f, 4092675.0f,
  4091840.0f, 4092161.0f, 4091884.0f, 4091785.0f, 4091576.0f, 4091434.0f, 4091644.0f, 4091436.0f,
  4091503.0f, 4091124.0f, 4091446.0f, 4091516.0f, 4091399.0f, 4091167.0f, 4091032.0f, 4091035.0f,
  4091005.0f, 4090882.0f, 4090924.0f, 4090715.0f, 4091225.0f, 4090611.0f, 4090859.0f, 4090965.0f,
  4090627.0f, 4090600.0f, 4090651.0f, 4090195.0f, 4090375.0f, 4090289.0f, 4089556.0f, 4089696.0f,
  4090183.0f, 4089967.0f, 4090469.0f, 4090598.0f, 4090634.0f, 4091296.0f, 4091578.0f, 4091927.0f,
  4092226.0f, 4092751.0f, 4093753.0f, 4093682.0f, 4094261.0f, 4095119.0f, 4094718.0f, 4095255.0f,
  4095478.0f, 4095677.0f, 4096051.0f, 4096041.0f, 4095915.0f, 4095871.0f, 4095817.0f, 4096414.0f,
  4095546.0f, 4096057.0f, 4096303.0f, 4096216.0f, 4095989.0f, 4095837.0f, 4095563.0f, 4094985.0f,
  4094548.0f, 4094436.0f, 4094035.0f, 4094307.0f, 4093889.0f, 4093732.0f, 4093364.0f, 4093102.0f,
  4093088.0f, 4092706.0f, 4092804.0f, 4092226.0f, 4092648.0f, 4092477.0f, 4092197.0f, 4092181.0f,
  4091960.0f, 4091608.0f, 4091521.0f, 4091596.0f, 4091231.0f, 4091277.0f, 4091184.0f, 4090972.0f,
  4090915.0f, 4091112.0f, 4090997.0f, 4091246.0f, 4090687.0f, 4090763.0f, 4090930.0f, 4090750.0f,
  4090737.0f, 4090763.0f, 4090703.0f, 4090738.0f, 4090660.0f, 4090600.0f, 4090322.0f, 4090414.0f,
  4090285.0f, 4090078.0f, 4089969.0f, 4089441.0f, 4089351.0f, 4088938.0f, 4088965.0f, 4088770.0f,
  4088449.0f, 4088430.0f, 4088436.0f, 4088476.0f, 4088972.0f, 4089250.0f, 4089575.0f, 4089779.0f,
  4090062.0f, 4090967.0f, 4090623.0f, 4090993.0f, 4091678.0f, 4091422.0f, 4092191.0f, 4092187.0f,
  4092616.0f, 4092497.0f, 4093180.0f, 4093179.0f, 4093290.0f, 4093582.0f, 4093492.0f, 4093762.0f,
  4093802.0f, 4093400.0f, 4093130.0f, 4093203.0f, 4093051.0f, 4093024.0f, 4092641.0f, 4092304.0f,
  4092021.0f, 4091425.0f, 4091243.0f, 4090748.0f, 4090105.0f, 4090078.0f, 4089843.0f, 4090150.0f,
  4089527.0f, 4089090.0f, 4089428.0f, 4088686.0f, 4088666.0f, 4088769.0f, 4088485.0f, 4088609.0f,
  4088566.0f, 4088460.0f, 4088208.0f, 4087848.0f, 4087828.0f, 4087205.0f, 4087018.0f, 4087409.0f,
  4086671.0f, 4085836.0f, 4086270.0f, 4085620.0f, 4086059.0f, 4085735.0f, 4085234.0f, 4085355.0f,
  4085469.0f, 4085370.0f, 4084595.0f, 4084528.0f, 4084497.0f, 4084359.0f, 4084553.0f, 4084241.0f,
  4084404.0f, 4084144.0f, 4084351.0f, 4084146.0f, 4084071.0f, 4083865.0f, 4083976.0f, 4084322.0f,
  4084617.0f, 4084884.0f, 4085153.0f, 4086069.0f, 4086046.0f, 4086589.0f, 4087127.0f, 4087224.0f,
  4087927.0f, 4088021.0f, 4088619.0f, 4089044.0f, 4089189.0f, 4089533.0f, 4089310.0f, 4089115.0f,
  4089287.0f, 4089166.0f, 4088874.0f, 4088793.0f, 4088336.0f, 4088662.0f, 4088288.0f, 4088375.0f,
  4088798.0f, 4088288.0f, 4088359.0f, 4088806.0f, 4088263.0f, 4088422.0f, 4088430.0f, 4087882.0f,
  4087989.0f, 4087542.0f, 4087753.0f, 4087145.0f, 4087071.0f, 4087003.0f, 4087056.0f, 4086969.0f,
  4086848.0f, 4086669.0f, 4086535.0f, 4086765.0f, 4086403.0f, 4086445.0f, 4086535.0f, 4086261.0f,
  4086447.0f, 4085895.0f, 4085971.0f, 4085666.0f, 4084927.0f, 4085186.0f, 4084638.0f, 4084809.0f,
  4084635.0f, 4084715.0f, 4084350.0f, 4084686.0f, 4084391.0f, 4084552.0f, 4084329.0f, 4084772.0f,
  4084554.0f, 4084646.0f, 4084860.0f, 4085057.0f, 4085023.0f, 4084877.0f, 4085207.0f, 4085319.0f,
  4085629.0f, 4085787.0f, 4086146.0f, 4086324.0f, 4086916.0f, 4087992.0f, 4087911.0f, 4089075.0f,
  4089845.0f, 4089721.0f, 4090886.0f, 4090868.0f, 4091206.0f, 4091293.0f, 4091475.0f, 4091984.0f,
  4091586.0f, 4091994.0f, 4092271.0f, 4091571.0f, 4091947.0f, 4092263.0f, 4091808.0f, 4091682.0f,
  4091388.0f, 4091385.0f, 4091677.0f, 4091292.0f, 4091143.0f, 4091256.0f, 4090904.0f, 4090794.0f,
  4090511.0f, 4090222.0f, 4090083.0f, 4090213.0f, 4090410.0f, 4090427.0f, 4090608.0f, 4090653.0f,
  4090495.0f, 4090837.0f, 4090302.0f, 4089994.0f, 4089842.0f, 4089296.0f, 4089691.0f, 4089228.0f,
  4089122.0f, 4088986.0f, 4089219.0f, 4089165.0f, 4089201.0f, 4089128.0f, 4089113.0f, 4089060.0f,
  4088597.0f, 4088706.0f, 4088663.0f, 4087652.0f, 4088116.0f, 4087495.0f, 4087716.0f, 4087761.0f,
  4087728.0f, 4086977.0f, 4087092.0f, 4086709.0f, 4086260.0f, 4085872.0f, 4085240.0f, 4084784.0f,
  4084656.0f, 4084590.0f, 4084549.0f, 4084580.0f, 4084932.0f, 4085446.0f, 4085704.0f, 4086634.0f,
  4086836.0f, 4087508.0f, 4088037.0f, 4088331.0f, 4089392.0f, 4089388.0f, 4090076.0f, 4090180.0f,
  4090496.0f, 4090537.0f, 4090834.0f, 4091074.0f, 4091003.0f, 4091164.0f, 4091525.0f, 4091399.0f,
  4091723.0f, 4091602.0f, 4091802.0f, 4091660.0f, 4091908.0f, 4091695.0f, 4091641.0f, 4091850.0f,
  4091579.0f, 4091459.0f, 4091678.0f, 4091568.0f, 4091471.0f, 4091432.0f, 4090964.0f, 4091181.0f,
  4091069.0f, 4091044.0f, 4091297.0f, 4091085.0f, 4090877.0f, 4090890.0f, 4090634.0f, 4091325.0f,
  4091050.0f, 4091209.0f, 4090866.0f, 4091297.0f, 4091004.0f, 4091178.0f, 4090463.0f, 4090576.0f,
  4090034.0f, 4090259.0f, 4090037.0f, 4090280.0f, 4090415.0f, 4090321.0f, 4090614.0f, 4090973.0f,
  4090921.0f, 4090148.0f, 4090559.0f, 4090204.0f, 4090300.0f, 4089839.0f, 4090220.0f, 4089895.0f,
  4089900.0f, 4089732.0f, 4089856.0f, 4089567.0f, 4089742.0f, 4089308.0f, 4089348.0f, 4088999.0f
};

void setup() {
  Serial.begin(115200);
  randomSeed(analogRead(0));  // Semilla para valores aleatorios para simular la presión.

  //Iniciamos el sensor de Temperatura
  Wire.begin(I2C_SDA, I2C_SCL);
  Serial.println("Inicializando sensor BMP280...");
  if (!bmp.begin(0x76)) {
    Serial.println("No se encontró sensor BMP280 en 0x76");
    while (1);
  }
  Serial.println("Sensor BMP280 inicializado.");

  BLEDevice::init("NombreDeTuWearable");
  pServer = BLEDevice::createServer();
  pServer->setCallbacks(new MyServerCallbacks());

  BLEService* pService = pServer->createService(SERVICE_UUID);

  pTxCharacteristic = pService->createCharacteristic(
    CHARACTERISTIC_UUID_TX,
    BLECharacteristic::PROPERTY_NOTIFY | BLECharacteristic::PROPERTY_READ
  );
  pTxCharacteristic->addDescriptor(new BLE2902());

  //BLECharacteristic* pRxCharacteristic = pService->createCharacteristic(
  //  CHARACTERISTIC_UUID_RX,
  //  BLECharacteristic::PROPERTY_WRITE | BLECharacteristic::PROPERTY_WRITE_NR
  //);

  pService->start();

  BLEAdvertising *pAdvertising = BLEDevice::getAdvertising();
  pAdvertising->addServiceUUID(SERVICE_UUID);
  pAdvertising->setScanResponse(false);
  pAdvertising->setMinPreferred(0x06);  // valores típicos
  pAdvertising->setMaxPreferred(0x12);
  //pAdvertising->setScanResponse(true);
  //pAdvertising->setMinPreferred(0x0c);
  //pAdvertising->setMaxPreferred(0x12);

  pServer->startAdvertising();
  Serial.println("Esperando conexión BLE...");
}

void loop(){

    remove_trend(ppg_data, detrended, PPG_LEN, WINDOW);
    normalize_minmax(detrended, normalized, PPG_LEN);
    int n_peaks = find_peaks(normalized, PPG_LEN, peaks, MIN_PROM, MIN_DIST);
    float bpm = estimate_bpm(peaks, n_peaks, FS);


    remove_trend(ppg2_data, detrended2, PPG_LEN, WINDOW);
    normalize_minmax(detrended2, normalized2, PPG_LEN);
    float spo2 = estimate_spo2(normalized2, normalized, PPG_LEN);


    
    float estimate_spo2(float* ir, float* red, int len);

    if (!isnan(bpm)) {
      Serial.print("✅ BPM estimado: ");
      Serial.println(bpm, 2);
    } else {
      Serial.println("❌ No se pudo estimar el BPM.");
    }

    if (deviceConnected) {
    // Generar datos aleatorios simulados
      float temperatura = bmp.readTemperature();
      
      //int spo2 = random(95, 100);       // Oxigenación
      //float temp = random(360, 380) / 10.0;  // Temperatura entre 36.0 y 38.0
  
      String json = "{\"hr\":" + String(bpm) +
                    ",\"spo2\":" + String(spo2) +
                    ",\"temp\":" + String(temperatura, 1) +
                    ",\"hr2\":" + String(bpm + random(-2, 3)) +
                    "}";
  
      Serial.println("Enviando JSON: " + json);

    pTxCharacteristic->setValue(json.c_str());
    pTxCharacteristic->notify();

    delay(3000);  //Delay para simular el tiempo de espera.
  } else {
    delay(500);
  }
  
}
